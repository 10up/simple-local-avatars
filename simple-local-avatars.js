let simple_local_avatar_frame,avatar_spinner,avatar_ratings,avatar_container,avatar_form_button,avatar_preview,avatar_input,avatar_blob,current_avatar,avatar_working=!1;function avatar_lock(a){null==avatar_spinner&&(avatar_ratings=document.getElementById("simple-local-avatar-ratings"),avatar_spinner=jQuery(document.getElementById("simple-local-avatar-spinner")),avatar_container=document.getElementById("simple-local-avatar-photo"),avatar_form_button=jQuery(avatar_ratings).closest("form").find("input[type=submit]")),"unlock"==a?(avatar_working=!1,avatar_form_button.removeAttr("disabled"),avatar_spinner.hide()):(avatar_working=!0,avatar_form_button.attr("disabled","disabled"),avatar_spinner.show())}function simple_local_avatar_calculate_image_select_options(a,t){const e=t.get("control");parseInt(e.params.flex_width,10),parseInt(e.params.flex_height,10);var r=a.get("width"),i=a.get("height");let l=parseInt(e.params.width,10),o=parseInt(e.params.height,10);var n=l/o;t.set("canSkipCrop",!e.mustBeCropped(!1,!1,l,o,r,i));var _=l,a=o;n<r/i?(o=i,l=o*n):(l=r,o=l/n);t=(r-l)/2,n=(i-o)/2;return{handles:!0,keys:!0,instance:!0,persistent:!0,imageWidth:r,imageHeight:i,minWidth:_>l?l:_,minHeight:a>o?o:a,x1:t,y1:n,x2:l+t,y2:o+n,aspectRatio:l+":"+o}}function simple_local_avatar_set_image_from_url(a,t,e,r){const i={};i.url=a,i.thumbnail_url=a,i.timestamp=_.now(),t&&(i.attachment_id=t),e&&(i.width=e),r&&(i.height=r),avatar_lock("lock"),jQuery.post(ajaxurl,{action:"assign_simple_local_avatar_media",media_id:t,user_id:i10n_SimpleLocalAvatars.user_id,_wpnonce:i10n_SimpleLocalAvatars.mediaNonce}).done(function(a){""!=a&&(avatar_container.innerHTML=a,jQuery("#simple-local-avatar-remove").show(),avatar_ratings.disabled=!1)}).always(function(){avatar_lock("unlock")})}function simple_local_avatar_set_image_from_attachment(a){avatar_lock("lock"),jQuery.post(ajaxurl,{action:"assign_simple_local_avatar_media",media_id:a.id,user_id:i10n_SimpleLocalAvatars.user_id,_wpnonce:i10n_SimpleLocalAvatars.mediaNonce}).done(function(a){""!=a&&(avatar_container.innerHTML=a,jQuery("#simple-local-avatar-remove").show(),avatar_ratings.disabled=!1,avatar_lock("unlock"))}).always(function(){avatar_lock("unlock")})}jQuery(document).ready(function(t){avatar_input=t("#simple-local-avatar"),avatar_preview=t("#simple-local-avatar-photo img"),current_avatar=avatar_preview.attr("src"),avatar_ratings=t("#simple-local-avatar-ratings"),avatar_container=t("#simple-local-avatar-photo"),t("#simple-local-avatar-media").on("click",function(a){if(a.preventDefault(),!avatar_working){const t={id:"control-id",params:{flex_width:!1,flex_height:!1,width:200,height:200},mustBeCropped:function(a,t,e,r,i,l){return i!==e||l!==distH}};simple_local_avatar_frame=wp.media({button:{text:i10n_SimpleLocalAvatars.selectCrop,close:!1},states:[new wp.media.controller.Library({title:i10n_SimpleLocalAvatars.selectCrop,library:wp.media.query({type:"image"}),multiple:!1,date:!1,priority:20,suggestedWidth:200,suggestedHeight:200}),new wp.media.controller.CustomizeImageCropper({imgSelectOptions:simple_local_avatar_calculate_image_select_options,control:t})]}),simple_local_avatar_frame.on("cropped",function(a){var{url:t}=a;simple_local_avatar_set_image_from_url(t,a.id,a.width,a.height)}),simple_local_avatar_frame.on("skippedcrop",function(a){var t=a.get("url"),e=a.get("width"),r=a.get("height");simple_local_avatar_set_image_from_url(t,a.id,e,r)}),simple_local_avatar_frame.on("select",function(){const a=simple_local_avatar_frame.state().get("selection").first().toJSON();t.params.width!==a.width||t.params.height!==a.height||t.params.flex_width||t.params.flex_height?simple_local_avatar_frame.setState("cropper"):(a.dst_width=a.width,a.dst_height=a.height,simple_local_avatar_set_image_from_attachment(a),simple_local_avatar_frame.close())}),simple_local_avatar_frame.open()}}),t("#simple-local-avatar-remove").on("click",function(a){a.preventDefault(),avatar_working||(avatar_lock("lock"),t.get(ajaxurl,{action:"remove_simple_local_avatar",user_id:i10n_SimpleLocalAvatars.user_id,_wpnonce:i10n_SimpleLocalAvatars.deleteNonce}).done(function(a){""!=a&&(avatar_container.innerHTML=a,t("#simple-local-avatar-remove").hide(),avatar_ratings.disabled=!0)}).always(function(){avatar_lock("unlock")}))}),avatar_input.on("change",function(a){avatar_preview.attr("srcset",""),avatar_preview.attr("height","auto"),URL.revokeObjectURL(avatar_blob),0<a.target.files.length?(avatar_blob=URL.createObjectURL(a.target.files[0]),avatar_preview.attr("src",avatar_blob)):avatar_preview.attr("src",current_avatar)})});